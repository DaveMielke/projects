From 3b6f6f623e39ff2cbe3d7f36bdcc5b6a24b43c25 Mon Sep 17 00:00:00 2001
From: Ander Conselvan de Oliveira <conselvan2@gmail.com>
Date: Fri, 27 Jul 2012 13:30:51 +0300
Subject: [PATCH 2/3] libdrm: Fix bogus increment of a property set object
 count

If drmModePropertySetAdd() is called with the following property pairs
it will mistakenly increase the object count:

  (4, 1), (5,1), (4, 2).

When adding the third pair, the new_obj variable would be set when prev
points to (4, 1) since it disregarded the value of the previous item.

This patch changes the logic so that the obj count is incresed only if
both the previous and next items have differing object ids.
---
 xf86drmMode.c | 16 ++++++----------
 1 file changed, 6 insertions(+), 10 deletions(-)

diff --git a/xf86drmMode.c b/xf86drmMode.c
index 5676221..7f3bc5e 100644
--- a/xf86drmMode.c
+++ b/xf86drmMode.c
@@ -1174,10 +1174,8 @@ int drmModePropertySetAdd(drmModePropertySetPtr set,
 
 	/* keep it sorted by object_id and property_id */
 	while (prev->next) {
-		if (prev->next->object_id > object_id) {
-			new_obj = true;
+		if (prev->next->object_id > object_id)
 			break;
-		}
 
 		if (prev->next->object_id == object_id &&
 		    prev->next->property_id >= property_id)
@@ -1186,8 +1184,8 @@ int drmModePropertySetAdd(drmModePropertySetPtr set,
 		prev = prev->next;
 	}
 
-	if (!prev->next &&
-	    (prev == &set->list || prev->object_id != object_id))
+	if ((prev == &set->list || prev->object_id != object_id) &&
+	    (!prev->next || prev->next->object_id != object_id))
 		new_obj = true;
 
 	/* replace or add? */
@@ -1236,10 +1234,8 @@ int drmModePropertySetAddBlob(drmModePropertySetPtr set,
 
 	/* keep it sorted by object_id and property_id */
 	while (prev->next) {
-		if (prev->next->object_id > object_id) {
-			new_obj = true;
+		if (prev->next->object_id > object_id)
 			break;
-		}
 
 		if (prev->next->object_id == object_id &&
 		    prev->next->property_id >= property_id)
@@ -1248,8 +1244,8 @@ int drmModePropertySetAddBlob(drmModePropertySetPtr set,
 		prev = prev->next;
 	}
 
-	if (!prev->next &&
-	    (prev == &set->list || prev->object_id != object_id))
+	if ((prev == &set->list || prev->object_id != object_id) &&
+	    (!prev->next || prev->next->object_id != object_id))
 		new_obj = true;
 
 	/* replace or add? */
-- 
2.2.0.rc0.207.ga3a616c

