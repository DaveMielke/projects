From 9225fd02e2cd8ff6680fc03449b34bc0ae86c8bc Mon Sep 17 00:00:00 2001
From: Wang Tiatian <tiantian.wang@intel.com>
Date: Fri, 8 Sep 2017 11:15:31 -0400
Subject: [PATCH 6/7] update gen8 avc encoder code path

Signed-off-by: Wang Tiatian <tiantian.wang@intel.com>
---
 src/gen8_mfc.c | 6 +++++-
 src/gen8_vme.c | 9 +++++++--
 2 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/gen8_mfc.c b/src/gen8_mfc.c
index b6bf4a0..1016d22 100644
--- a/src/gen8_mfc.c
+++ b/src/gen8_mfc.c
@@ -38,6 +38,7 @@
 #include "i965_structs.h"
 #include "i965_drv_video.h"
 #include "i965_encoder.h"
+#include "i965_encoder_api.h"
 #include "i965_encoder_utils.h"
 #include "gen6_mfc.h"
 #include "gen6_vme.h"
@@ -4564,7 +4565,10 @@ Bool gen8_mfc_context_init(VADriverContextP ctx, struct intel_encoder_context *e
 
     if (IS_CHERRYVIEW(i965->intel.device_info) && encoder_context->codec == CODEC_VP8)
         return i965_encoder_vp8_pak_context_init(ctx, encoder_context);
-
+    if (IS_GEN8(i965->intel.device_info) && (encoder_context->codec == CODEC_H264 ||
+                                             encoder_context->codec == CODEC_H264_MVC)) {
+        return gen9_avc_pak_context_init(ctx, encoder_context);
+    }
     mfc_context = calloc(1, sizeof(struct gen6_mfc_context));
     assert(mfc_context);
     mfc_context->gpe_context.surface_state_binding_table.length = (SURFACE_STATE_PADDED_SIZE + sizeof(unsigned int)) * MAX_MEDIA_SURFACES_GEN6;
diff --git a/src/gen8_vme.c b/src/gen8_vme.c
index 0b62b9e..6fc27e6 100644
--- a/src/gen8_vme.c
+++ b/src/gen8_vme.c
@@ -38,6 +38,7 @@
 #include "i965_defines.h"
 #include "i965_drv_video.h"
 #include "i965_encoder.h"
+#include "i965_encoder_api.h"
 #include "gen6_vme.h"
 #include "gen6_mfc.h"
 
@@ -1337,9 +1338,13 @@ Bool gen8_vme_context_init(VADriverContextP ctx, struct intel_encoder_context *e
     struct i965_kernel *vme_kernel_list = NULL;
     int i965_kernel_num;
 
-    if (IS_CHERRYVIEW(i965->intel.device_info) && encoder_context->codec == CODEC_VP8)
+    if (IS_CHERRYVIEW(i965->intel.device_info) && encoder_context->codec == CODEC_VP8) {
         return i965_encoder_vp8_vme_context_init(ctx, encoder_context);
-
+    } else if (IS_GEN8(i965->intel.device_info) && (
+                   encoder_context->codec == CODEC_H264 ||
+                   encoder_context->codec == CODEC_H264_MVC)) {
+        return gen9_avc_vme_context_init(ctx, encoder_context);
+    }
     switch (encoder_context->codec) {
     case CODEC_H264:
     case CODEC_H264_MVC:
-- 
2.13.6

