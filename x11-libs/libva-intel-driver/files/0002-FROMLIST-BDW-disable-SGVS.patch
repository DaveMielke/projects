From d8816eacec7114e0b2ea887a39e502bac5f8444d Mon Sep 17 00:00:00 2001
From: Joe Konno <joe.konno@intel.com>
Date: Tue, 13 Jan 2015 14:06:33 -0800
Subject: [PATCH 2/2] FROMLIST: BDW+: disable SGVS
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

BDW introduces separate packets for controlling instancing and system
generated values (eg vertex id and instance id).  We don't use
instancing, but still need to disable sgvs to avoid undefined behaviour
when some other driver (mesa) uses it.

Signed-off-by: Joe Konno <joe.konno@intel.com>
Signed-off-by: Kristian HÃ¸gsberg <krh@bitplanet.net>

Conflicts (does not exist yet):
	src/gen9_render.c

List: http://lists.freedesktop.org/archives/libva/2015-January/003106.html
Signed-off-by: Joe Konno <joe.konno@intel.com>
---
 src/gen8_render.c  | 4 ++++
 src/i965_defines.h | 1 +
 2 files changed, 5 insertions(+)

diff --git a/src/gen8_render.c b/src/gen8_render.c
index c85ff43..671404b 100644
--- a/src/gen8_render.c
+++ b/src/gen8_render.c
@@ -1001,6 +1001,10 @@ gen8_emit_vertex_element_state(VADriverContextP ctx)
 	OUT_BATCH(batch, i);
 	OUT_BATCH(batch, 0);
     }
+
+    /* Disable system-generated values. */
+    OUT_BATCH(batch, GEN8_3DSTATE_VF_SGVS | (2 - 2));
+    OUT_BATCH(batch, 0);
 }
 
 static void
diff --git a/src/i965_defines.h b/src/i965_defines.h
index d8178cf..0bce278 100755
--- a/src/i965_defines.h
+++ b/src/i965_defines.h
@@ -717,6 +717,7 @@
 #define _3DPRIM_LINESTRIP_CONT_BF 0x14
 #define _3DPRIM_TRIFAN_NOSTIPPLE  0x15
 
+#define GEN8_3DSTATE_VF_SGVS		CMD(3, 0, 0x4a)
 #define GEN8_3DSTATE_VF_TOPOLOGY	CMD(3, 0, 0x4b)
 
 #define I965_TILEWALK_XMAJOR                 0
-- 
2.2.1

