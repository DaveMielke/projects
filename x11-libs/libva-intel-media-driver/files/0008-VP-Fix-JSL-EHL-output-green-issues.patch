From 16b6edd5978b461d67eed9d05a8885bbc91bea4a Mon Sep 17 00:00:00 2001
From: YanfengMi <yanfeng.mi@intel.com>
Date: Mon, 13 Apr 2020 16:31:47 +0800
Subject: [PATCH] [VP] Fix JSL/EHL output green issues

Fix JSL/EHL output green issues

Change-Id: I233e3d8b84b53b066c320e30fcf8444ee9be0bc8
---
 media_driver/agnostic/common/vp/hal/vphal_render_vebox_base.cpp   | 8 ++++++++
 .../agnostic/gen11/vp/hal/vphal_render_vebox_g11_base.cpp         | 3 ++-
 media_driver/linux/gen11/ddi/media_sku_wa_g11.cpp                 | 2 ++
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/media_driver/agnostic/common/vp/hal/vphal_render_vebox_base.cpp b/media_driver/agnostic/common/vp/hal/vphal_render_vebox_base.cpp
index 640133d47e65..b31ed5b9190b 100644
--- a/media_driver/agnostic/common/vp/hal/vphal_render_vebox_base.cpp
+++ b/media_driver/agnostic/common/vp/hal/vphal_render_vebox_base.cpp
@@ -2391,6 +2391,14 @@ void VPHAL_VEBOX_STATE::VeboxSetRenderingFlags(
 
     pRenderHal                  = pVeboxState->m_pRenderHal;
 
+    // VEBOX needed to be bypass for VE+COMP/SFC cases when no vebox feature.
+    if (MEDIA_IS_SKU(pVeboxState->GetSkuTable(), FtrDisableVEBoxFeatures) &&
+        !IS_VPHAL_OUTPUT_PIPE_VEBOX(pRenderData))
+    {
+        pRenderData->bVeboxBypass = true;
+        return;
+    }
+
     VeboxSetCommonRenderingFlags(pSrc, pRenderTarget);
 
     // surface height should be a multiple of 4 when DN/DI is enabled and input format is Planar 420
diff --git a/media_driver/agnostic/gen11/vp/hal/vphal_render_vebox_g11_base.cpp b/media_driver/agnostic/gen11/vp/hal/vphal_render_vebox_g11_base.cpp
index b4c67670a1eb..3cc79b8cef88 100644
--- a/media_driver/agnostic/gen11/vp/hal/vphal_render_vebox_g11_base.cpp
+++ b/media_driver/agnostic/gen11/vp/hal/vphal_render_vebox_g11_base.cpp
@@ -2202,7 +2202,8 @@ VPHAL_OUTPUT_PIPE_MODE VPHAL_VEBOX_STATE_G11_BASE::GetOutputPipe(
          (pSrcSurface->Format == Format_P010 ||
           pSrcSurface->Format == Format_P016 ||
           pSrcSurface->Format == Format_NV12)) ||
-         !this->IsDiFormatSupported(pSrcSurface)))
+         !this->IsDiFormatSupported(pSrcSurface) ||
+         MEDIA_IS_SKU(pVeboxState->m_pSkuTable, FtrDisableVEBoxFeatures)))
     {
         OutputPipe = VPHAL_OUTPUT_PIPE_MODE_COMP;
         goto finish;
diff --git a/media_driver/linux/gen11/ddi/media_sku_wa_g11.cpp b/media_driver/linux/gen11/ddi/media_sku_wa_g11.cpp
index fdb9d946fd19..701cc8d52321 100644
--- a/media_driver/linux/gen11/ddi/media_sku_wa_g11.cpp
+++ b/media_driver/linux/gen11/ddi/media_sku_wa_g11.cpp
@@ -408,6 +408,8 @@ static bool InitEhlMediaWa(struct GfxDeviceInfo *devInfo,
 
     MEDIA_WR_WA(waTable, WaVeboxInputHeight16Aligned, 1);
 
+    MEDIA_WR_WA(waTable, Wa16KInputHeightNV12Planar420, 1);
+
     return true;
 }
 
-- 
2.7.4

