commit b73fa8fef6ec622793a0d037032a5eb43ef470a4
Author: David James <davidjames@google.com>
Date:   Wed Jan 26 11:43:11 2011 -0800

    Commit fast-build patch to portage_tool repository.
    
    This patch allows us to selectively disable Portage locks in parallel_emerge.
    It is not intended to be upstreamed but is left in for now until we find a way
    to replace it (e.g. by integrating parallel emerge support directly into portage
    itself).
    
    Change-Id: I4ea50e206102b249ba01d2f760ebaba221bddd18
    
    BUG=chromium-os:11324
    TEST=build_packages --nousepkg
    
    Review URL: http://codereview.chromium.org/6377009

diff --git a/pym/portage/dbapi/vartree.py b/pym/portage/dbapi/vartree.py
index ac2a0ce..bcf841c 100644
--- a/pym/portage/dbapi/vartree.py
+++ b/pym/portage/dbapi/vartree.py
@@ -185,7 +185,7 @@ class vardbapi(dbapi):
 		"""
 		if self._lock_count:
 			self._lock_count += 1
-		else:
+		elif os.environ.get("PORTAGE_LOCKS") != "false":
 			if self._lock is not None:
 				raise AssertionError("already locked")
 			# At least the parent needs to exist for the lock file.
@@ -201,7 +201,7 @@ class vardbapi(dbapi):
 		"""
 		if self._lock_count > 1:
 			self._lock_count -= 1
-		else:
+		elif os.environ.get("PORTAGE_LOCKS") != "false":
 			if self._lock is None:
 				raise AssertionError("not locked")
 			self._lock_count = 0
