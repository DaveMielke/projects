From 7961f2d9780dbcdadc7e584047636cdc2c85f10e Mon Sep 17 00:00:00 2001
From: Akshu Agrawal <akshu.agrawal@amd.com>
Date: Thu, 25 Apr 2019 16:41:49 +0530
Subject: [PATCH] winsys/amdgpu: Restrict allocation to GTT for small vram size

To avoid evictions, use GTT only for allocation on devices with
small vram size.

Change-Id: Idb5b2a48146429e644d5e20f83da33e8ffb92ce6
Signed-off-by: Akshu Agrawal <akshu.agrawal@amd.com>
---
 src/gallium/winsys/amdgpu/drm/amdgpu_bo.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/gallium/winsys/amdgpu/drm/amdgpu_bo.c b/src/gallium/winsys/amdgpu/drm/amdgpu_bo.c
index 58979bd4ea..5437601747 100644
--- a/src/gallium/winsys/amdgpu/drm/amdgpu_bo.c
+++ b/src/gallium/winsys/amdgpu/drm/amdgpu_bo.c
@@ -492,8 +492,15 @@ static struct amdgpu_winsys_bo *amdgpu_create_bo(struct amdgpu_winsys *ws,
     * shared with the OS, allow VRAM placements too. The idea is not to use
     * VRAM usefully, but to use it so that it's not unused and wasted.
     */
-   if (!ws->info.has_dedicated_vram)
-      request.preferred_heap |= AMDGPU_GEM_DOMAIN_GTT;
+   if (!ws->info.has_dedicated_vram) {
+      /* For devices having small VRAM size use GTT only to
+       * avoid evictions.
+       */
+      if (ws->info.vram_size <= 16777216)
+         request.preferred_heap = AMDGPU_GEM_DOMAIN_GTT;
+      else
+         request.preferred_heap |= AMDGPU_GEM_DOMAIN_GTT;
+      }
 
    if (flags & RADEON_FLAG_NO_CPU_ACCESS)
       request.flags |= AMDGPU_GEM_CREATE_NO_CPU_ACCESS;
-- 
2.20.1

