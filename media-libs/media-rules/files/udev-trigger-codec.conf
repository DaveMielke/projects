# Copyright 2015 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "Replay codec video device udev events"
author          "chromium-os-dev@chromium.org"

# This job is used to replay events of codec video devices. Chrome queries
# the video nodes for hardware decode and encode capabilities when it starts.
# The video nodes have to be present before it starts. So this job is a task
# and blocks Chrome to start.
#
# To avoid hardcoding the names in udev-trigger.conf, these events are
# replayed again there. But these events are simple and do not increase
# much boot time.
start on starting boot-services
task

script
  # TODO(mka): split this ebuild into the corresponding chipset overlays.

  if grep -q exynos /proc/device-tree/compatible; then
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=s5p-*"
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=exynos-gsc*"
  fi

  if grep -q rk3288 /proc/device-tree/compatible; then
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=rk3288-vpu*"
  fi

  if grep -q rk3399 /proc/device-tree/compatible; then
    udevadm trigger --action=add --subsystem-match=platform \
      --attr-match="name=rockchip,rk3399-vpu-enc"
    udevadm trigger --action=add --subsystem-match=platform \
      --attr-match="name=rockchip,rk3399-vdec-dec"
    udevadm trigger --action=add --subsystem-match=platform \
      --attr-match="name=rockchip,rk3399-vpu-dec"
  fi

  udevadm trigger --action=add --subsystem-match=video4linux \
    --attr-match="name=go2001*"

  if grep -q mt8173 /proc/device-tree/compatible; then
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=mtk-vcodec*"
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=mtk-mdp:m2m"
    udevadm trigger --action=add --subsystem-match=video4linux \
      --attr-match="name=mtk-jpeg-dec"
  fi

  exec udevadm settle
end script
