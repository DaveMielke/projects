Index: src/engine.c
diff --git a/src/engine.c b/src/engine.c
index a9bf9827d432eb14c3dfa3a8b1417a15922de52f..30bf2ac1f901c8938ff4305ccc2afde1516f6c87 100644
--- a/src/engine.c
+++ b/src/engine.c
@@ -8,7 +8,6 @@ typedef struct _IBusZinniaEngineClass IBusZinniaEngineClass;
 
 struct _IBusZinniaEngine {
     IBusEngine parent;
-    zinnia_recognizer_t *recognizer;
     zinnia_character_t *character;
     zinnia_result_t *result;
     size_t stroke_count;
@@ -16,6 +15,7 @@ struct _IBusZinniaEngine {
 
 struct _IBusZinniaEngineClass {
     IBusEngineClass parent;
+    zinnia_recognizer_t *recognizer;
 };
 
 /* functions prototype */
@@ -33,6 +33,9 @@ static void     ibus_zinnia_engine_process_hand_writing_event
 static void     ibus_zinnia_engine_cancel_hand_writing
                                                      (IBusEngine              *engine,
                                                       guint                    n_strokes);
+static void     ibus_zinnia_engine_reset             (IBusEngine              *engine);
+static void     ibus_zinnia_engine_disable           (IBusEngine              *engine);
+static void     ibus_zinnia_engine_focus_out         (IBusEngine              *engine);
 
 G_DEFINE_TYPE (IBusZinniaEngine, ibus_zinnia_engine, IBUS_TYPE_ENGINE)
 
@@ -41,7 +44,7 @@ static const gchar model_path[] = "/usr/share/tegaki/models/zinnia/handwriting-j
 /* FIXME support Chinese and other languages */
 
 static gint
-normalize(gdouble x_or_y)
+normalize (gdouble x_or_y)
 {
     gint result = (gint)(x_or_y * zinnia_xy);
     if (result < 0)
@@ -52,6 +55,34 @@ normalize(gdouble x_or_y)
 }
 
 static void
+maybe_init_zinnia (IBusZinniaEngine *zinnia)
+{
+    if (zinnia->stroke_count == 0) {
+        g_return_if_fail (zinnia->character == NULL);
+        g_return_if_fail (zinnia->result == NULL);
+
+        zinnia->character = zinnia_character_new ();
+        zinnia_character_clear (zinnia->character);
+        zinnia_character_set_width (zinnia->character, zinnia_xy);
+        zinnia_character_set_height (zinnia->character, zinnia_xy);
+    }
+}
+
+static void
+destroy_zinnia (IBusZinniaEngine *zinnia)
+{
+    if (zinnia->character) {
+        zinnia_character_destroy (zinnia->character);
+        zinnia->character = NULL;
+    }
+    if (zinnia->result != NULL) {
+        zinnia_result_destroy (zinnia->result);
+        zinnia->result = NULL;
+    }
+    zinnia->stroke_count = 0;
+}
+
+static void
 ibus_zinnia_engine_class_init (IBusZinniaEngineClass *klass)
 {
     IBusObjectClass *ibus_object_class = IBUS_OBJECT_CLASS (klass);
@@ -62,30 +93,26 @@ ibus_zinnia_engine_class_init (IBusZinniaEngineClass *klass)
     engine_class->candidate_clicked = ibus_zinnia_engine_candidate_clicked;
     engine_class->process_hand_writing_event = ibus_zinnia_engine_process_hand_writing_event;
     engine_class->cancel_hand_writing = ibus_zinnia_engine_cancel_hand_writing;
+
+    engine_class->reset = ibus_zinnia_engine_reset;
+    engine_class->disable = ibus_zinnia_engine_disable;
+    engine_class->focus_out = ibus_zinnia_engine_focus_out;
+
+    klass->recognizer = zinnia_recognizer_new ();
+    g_return_if_fail (zinnia_recognizer_open (klass->recognizer, model_path));
 }
 
 static void
 ibus_zinnia_engine_init (IBusZinniaEngine *zinnia)
 {
-    zinnia->recognizer = zinnia_recognizer_new ();
-    zinnia->character = zinnia_character_new ();
-
-    g_return_if_fail (zinnia_recognizer_open (zinnia->recognizer, model_path));
-    zinnia_character_clear (zinnia->character);
-    zinnia_character_set_width (zinnia->character, zinnia_xy);
-    zinnia_character_set_height (zinnia->character, zinnia_xy);
-    zinnia->result = NULL;
-    zinnia->stroke_count = 0;
+    if (g_object_is_floating (zinnia)) {
+        g_object_ref_sink (zinnia);
+    }
 }
 
 static void
 ibus_zinnia_engine_destroy (IBusZinniaEngine *zinnia)
 {
-    zinnia_character_destroy (zinnia->character);
-    zinnia_recognizer_destroy (zinnia->recognizer);
-    if (zinnia->result != NULL) {
-        zinnia_result_destroy (zinnia->result);
-    }
     ((IBusObjectClass *) ibus_zinnia_engine_parent_class)->destroy ((IBusObject *) zinnia);
 }
 
@@ -102,6 +129,7 @@ ibus_zinnia_engine_candidate_clicked (IBusEngine *engine,
     IBusText *text = ibus_text_new_from_string (zinnia_result_value (zinnia->result, index));
     ibus_engine_commit_text (engine, text);
     ibus_engine_hide_lookup_table (engine);
+    destroy_zinnia (zinnia);
 }
 
 static void
@@ -116,6 +144,7 @@ ibus_zinnia_engine_process_hand_writing_event (IBusEngine         *engine,
     g_return_if_fail (coordinates_len >= 4);
     g_return_if_fail ((coordinates_len & 1) == 0);
 
+    maybe_init_zinnia (zinnia);
     for (i = 1; i < coordinates_len; i += 2) {
         zinnia_character_add (zinnia->character,
                               zinnia->stroke_count,
@@ -127,9 +156,14 @@ ibus_zinnia_engine_process_hand_writing_event (IBusEngine         *engine,
     if (zinnia->result != NULL) {
         zinnia_result_destroy (zinnia->result);
     }
-    zinnia->result = zinnia_recognizer_classify (zinnia->recognizer,
+
+    IBusZinniaEngineClass *klass = G_TYPE_INSTANCE_GET_CLASS (zinnia,
+                                                              IBusZinniaEngine,
+                                                              IBusZinniaEngineClass);
+    zinnia->result = zinnia_recognizer_classify (klass->recognizer,
                                                  zinnia->character,
                                                  max_candidates);
+
     if (zinnia->result == NULL || zinnia_result_size (zinnia->result) == 0) {
         ibus_engine_hide_lookup_table (engine);
     } else {
@@ -152,10 +186,26 @@ ibus_zinnia_engine_cancel_hand_writing (IBusEngine              *engine,
                                         guint                    n_strokes)
 {
     IBusZinniaEngine *zinnia = (IBusZinniaEngine *) engine;
-
-    zinnia_character_clear (zinnia->character);
-    zinnia->stroke_count = 0;
     ibus_engine_hide_lookup_table (engine);
+    destroy_zinnia (zinnia);
 
     /* FIXME support n_strokes != 0 cases */
 }
+
+static void
+ibus_zinnia_engine_reset (IBusEngine *engine)
+{
+    ibus_zinnia_engine_cancel_hand_writing (engine, 0);
+}
+
+static void
+ibus_zinnia_engine_disable (IBusEngine *engine)
+{
+    ibus_zinnia_engine_cancel_hand_writing (engine, 0);
+}
+
+static void
+ibus_zinnia_engine_focus_out (IBusEngine *engine)
+{
+    ibus_zinnia_engine_cancel_hand_writing (engine, 0);
+}
